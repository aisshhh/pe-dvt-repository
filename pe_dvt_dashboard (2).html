<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE/DVT Monitoring System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .status-card {
            flex: 1;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .status-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .status-unit {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .normal { color: #27ae60; }
        .warning { color: #f39c12; }
        .critical { color: #e74c3c; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .alerts-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .alert {
            background: #fff;
            border-left: 4px solid;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .alert.critical {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .alert.warning {
            border-left-color: #f39c12;
            background: #fefbf2;
        }
        
        .alert.info {
            border-left-color: #3498db;
            background: #f2f8ff;
        }
        
        .alert-time {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .connected {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .disconnected {
            background: #fdeaea;
            color: #e74c3c;
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .patient-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .patient-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .patient-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .patient-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .risk-assessment {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .risk-meter {
            text-align: center;
            margin: 20px 0;
        }
        
        .risk-value {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .risk-low { color: #27ae60; }
        .risk-moderate { color: #f39c12; }
        .risk-high { color: #e74c3c; }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü´Ä PE/DVT Monitoring System</h1>
            <p class="subtitle">Wearable IoT-based Post-Treatment Monitoring for Elderly Patients</p>
            <div style="margin-top: 15px;">
                <span id="connectionStatus" class="connection-status disconnected">
                    <span class="connection-dot"></span>
                    ESP32 Disconnected
                </span>
            </div>
        </div>

        <div class="patient-info">
            <h3>üë§ Patient Information</h3>
            <div class="patient-details">
                <div class="patient-detail">
                    <span><strong>Name:</strong></span>
                    <span id="patientName">John Smith</span>
                </div>
                <div class="patient-detail">
                    <span><strong>Age:</strong></span>
                    <span id="patientAge">74 years</span>
                </div>
                <div class="patient-detail">
                    <span><strong>Device ID:</strong></span>
                    <span id="deviceId">ESP32-001</span>
                </div>
                <div class="patient-detail">
                    <span><strong>Last Surgery:</strong></span>
                    <span id="lastSurgery">Hip Replacement - 5 days ago</span>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-card">
                <h3>üíì Heart Rate</h3>
                <div id="heartRate" class="status-value normal">--</div>
                <div class="status-unit">BPM</div>
            </div>
            <div class="status-card">
                <h3>ü´Å SpO‚ÇÇ</h3>
                <div id="spo2" class="status-value normal">--</div>
                <div class="status-unit">%</div>
            </div>
            <div class="status-card">
                <h3>üå°Ô∏è Temperature</h3>
                <div id="temperature" class="status-value normal">--</div>
                <div class="status-unit">¬∞C</div>
            </div>
            <div class="status-card">
                <h3>ü¶µ Calf Circumference</h3>
                <div id="calfSize" class="status-value normal">--</div>
                <div class="status-unit">cm</div>
            </div>
            <div class="status-card">
                <h3>üö∂ Activity Level</h3>
                <div id="activity" class="status-value normal">--</div>
                <div class="status-unit">steps/hr</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-section">
                <div class="controls">
                    <button class="btn btn-primary" onclick="connectESP32()">Connect to ESP32</button>
                    <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                    <button class="btn btn-secondary" onclick="resetAlerts()">Clear Alerts</button>
                </div>
                
                <div class="chart-title">üìà Vital Signs Trend (Last 24 Hours)</div>
                <div class="chart-container">
                    <canvas id="vitalsChart"></canvas>
                </div>
                
                <div class="chart-title">ü©∏ Circulation Analysis (Pulse Transit Time)</div>
                <div class="chart-container">
                    <canvas id="circulationChart"></canvas>
                </div>
            </div>

            <div class="alerts-section">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">üö® Alerts & Notifications</h3>
                <div id="alertsList">
                    <div class="alert info">
                        <div class="alert-time">System initialized</div>
                        <div>Monitoring system is ready. Waiting for ESP32 connection...</div>
                    </div>
                </div>

                <div class="risk-assessment" style="margin-top: 30px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">‚ö†Ô∏è Risk Assessment</h3>
                    <div class="risk-meter">
                        <div id="riskValue" class="risk-value risk-low">LOW</div>
                        <div>Current PE/DVT Risk Level</div>
                    </div>
                    <div style="font-size: 0.9em; color: #7f8c8d; text-align: center;">
                        Based on: Mobility, Circulation, Swelling, Temperature
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for charts and data
        let vitalsChart, circulationChart;
        let isConnected = false;
        let websocket;
        let alertCount = 0;

        // Simulated sensor data (replace with ESP32 real data)
        let sensorData = {
            heartRate: 78,
            spo2: 98,
            temperature: 36.5,
            calfCircumference: 32.1,
            activity: 45,
            breathingRate: 16,
            pulseTransitTime: 180
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateDisplay();
            
            // Simulate data updates (replace with real ESP32 connection)
            setInterval(simulateDataUpdate, 3000);
            
            // Try to connect to ESP32 on load
            // connectESP32();
        });

        // Initialize Chart.js charts
        function initializeCharts() {
            const vitalsCtx = document.getElementById('vitalsChart').getContext('2d');
            const circulationCtx = document.getElementById('circulationChart').getContext('2d');

            // Generate sample time labels
            const timeLabels = [];
            for (let i = 23; i >= 0; i--) {
                timeLabels.push(`${i}:00`);
            }

            vitalsChart = new Chart(vitalsCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Heart Rate (BPM)',
                            data: generateSampleData(24, 70, 85),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'SpO‚ÇÇ (%)',
                            data: generateSampleData(24, 95, 99),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 60,
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 90,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            circulationChart = new Chart(circulationCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Pulse Transit Time (ms)',
                            data: generateSampleData(24, 170, 190),
                            borderColor: '#9b59b6',
                            backgroundColor: 'rgba(155, 89, 182, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Calf Temperature (¬∞C)',
                            data: generateSampleData(24, 35.8, 37.2),
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            display: true,
                            position: 'left',
                            min: 160,
                            max: 200
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 35,
                            max: 38,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Generate sample data for charts
        function generateSampleData(count, min, max) {
            return Array.from({length: count}, () => 
                Math.random() * (max - min) + min
            );
        }

        // Connect to ESP32 via WebSocket
        function connectESP32() {
            const ESP32_IP = "192.168.1.100"; // Update with your ESP32 IP
            const ESP32_PORT = "81";
            
            try {
                websocket = new WebSocket(`ws://${ESP32_IP}:${ESP32_PORT}/`);
                
                websocket.onopen = function(event) {
                    isConnected = true;
                    updateConnectionStatus();
                    addAlert('info', 'Connected to ESP32 successfully!');
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateSensorData(data);
                };
                
                websocket.onerror = function(error) {
                    addAlert('critical', 'WebSocket connection error!');
                    console.error('WebSocket error:', error);
                };
                
                websocket.onclose = function(event) {
                    isConnected = false;
                    updateConnectionStatus();
                    addAlert('warning', 'Connection to ESP32 lost. Attempting to reconnect...');
                    
                    // Auto-reconnect after 5 seconds
                    setTimeout(connectESP32, 5000);
                };
                
            } catch (error) {
                addAlert('critical', 'Failed to connect to ESP32: ' + error.message);
                console.error('Connection error:', error);
            }
        }

        // Update sensor data from ESP32
        function updateSensorData(data) {
            if (data.heartRate) sensorData.heartRate = data.heartRate;
            if (data.spo2) sensorData.spo2 = data.spo2;
            if (data.temperature) sensorData.temperature = data.temperature;
            if (data.calfCircumference) sensorData.calfCircumference = data.calfCircumference;
            if (data.activity) sensorData.activity = data.activity;
            if (data.pulseTransitTime) sensorData.pulseTransitTime = data.pulseTransitTime;
            
            updateDisplay();
            checkForAlerts(data);
        }

        // Simulate data updates (remove when connecting to real ESP32)
        function simulateDataUpdate() {
            if (!isConnected) {
                // Simulate some sensor variations
                sensorData.heartRate += (Math.random() - 0.5) * 4;
                sensorData.spo2 += (Math.random() - 0.5) * 0.5;
                sensorData.temperature += (Math.random() - 0.5) * 0.2;
                sensorData.activity = Math.max(0, sensorData.activity + (Math.random() - 0.5) * 10);
                
                // Clamp values to realistic ranges
                sensorData.heartRate = Math.max(60, Math.min(120, sensorData.heartRate));
                sensorData.spo2 = Math.max(90, Math.min(100, sensorData.spo2));
                sensorData.temperature = Math.max(35, Math.min(39, sensorData.temperature));
                
                updateDisplay();
                checkForAlerts(sensorData);
            }
        }

        // Update display with current sensor data
        function updateDisplay() {
            document.getElementById('heartRate').textContent = Math.round(sensorData.heartRate);
            document.getElementById('spo2').textContent = sensorData.spo2.toFixed(1);
            document.getElementById('temperature').textContent = sensorData.temperature.toFixed(1);
            document.getElementById('calfSize').textContent = sensorData.calfCircumference.toFixed(1);
            document.getElementById('activity').textContent = Math.round(sensorData.activity);
            
            // Update status colors
            updateStatusColor('heartRate', sensorData.heartRate, 60, 100);
            updateStatusColor('spo2', sensorData.spo2, 95, 100);
            updateStatusColor('temperature', sensorData.temperature, 36, 37.5);
            updateStatusColor('activity', sensorData.activity, 30, 100);
            
            // Update risk assessment
            updateRiskAssessment();
        }

        // Update status color based on normal ranges
        function updateStatusColor(elementId, value, normalMin, normalMax) {
            const element = document.getElementById(elementId);
            element.className = 'status-value';
            
            if (value < normalMin * 0.9 || value > normalMax * 1.1) {
                element.classList.add('critical');
            } else if (value < normalMin || value > normalMax) {
                element.classList.add('warning');
            } else {
                element.classList.add('normal');
            }
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (isConnected) {
                statusElement.className = 'connection-status connected';
                statusElement.innerHTML = '<span class="connection-dot"></span>ESP32 Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusElement.innerHTML = '<span class="connection-dot"></span>ESP32 Disconnected';
            }
        }

        // Check for alerts based on sensor data
        function checkForAlerts(data) {
            // Heart rate alerts
            if (data.heartRate > 100) {
                addAlert('warning', `Elevated heart rate detected: ${Math.round(data.heartRate)} BPM`);
            } else if (data.heartRate < 60) {
                addAlert('warning', `Low heart rate detected: ${Math.round(data.heartRate)} BPM`);
            }
            
            // SpO2 alerts
            if (data.spo2 < 95) {
                addAlert('critical', `Low oxygen saturation: ${data.spo2.toFixed(1)}%`);
            }
            
            // Temperature alerts
            if (data.temperature > 37.5) {
                addAlert('warning', `Elevated temperature: ${data.temperature.toFixed(1)}¬∞C`);
            }
            
            // Activity alerts
            if (data.activity < 10) {
                addAlert('warning', 'Low activity detected. Patient may need mobilization.');
            }
            
            // Simulate DVT risk factors
            if (Math.random() < 0.05) { // 5% chance to simulate alert
                const alerts = [
                    'Calf swelling detected - possible DVT risk',
                    'Asymmetric temperature difference between legs',
                    'Prolonged immobility detected',
                    'Irregular circulation pattern observed'
                ];
                addAlert('warning', alerts[Math.floor(Math.random() * alerts.length)]);
            }
        }

        // Add alert to the alerts list
        function addAlert(type, message) {
            const alertsList = document.getElementById('alertsList');
            const alertElement = document.createElement('div');
            alertElement.className = `alert ${type}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            alertElement.innerHTML = `
                <div class="alert-time">${timeString}</div>
                <div>${message}</div>
            `;
            
            alertsList.insertBefore(alertElement, alertsList.firstChild);
            
            // Keep only last 10 alerts
            while (alertsList.children.length > 10) {
                alertsList.removeChild(alertsList.lastChild);
            }
        }

        // Update risk assessment
        function updateRiskAssessment() {
            const riskElement = document.getElementById('riskValue');
            let riskScore = 0;
            
            // Calculate risk based on multiple factors
            if (sensorData.heartRate > 100 || sensorData.heartRate < 60) riskScore += 1;
            if (sensorData.spo2 < 95) riskScore += 2;
            if (sensorData.temperature > 37.5) riskScore += 1;
            if (sensorData.activity < 20) riskScore += 2;
            
            // Set risk level
            riskElement.className = 'risk-value';
            if (riskScore >= 4) {
                riskElement.textContent = 'HIGH';
                riskElement.classList.add('risk-high');
            } else if (riskScore >= 2) {
                riskElement.textContent = 'MODERATE';
                riskElement.classList.add('risk-moderate');
            } else {
                riskElement.textContent = 'LOW';
                riskElement.classList.add('risk-low');
            }
        }

        // Export data function
        function exportData() {
            const data = {
                timestamp: new Date().toISOString(),
                patientInfo: {
                    name: document.getElementById('patientName').textContent,
                    age: document.getElementById('patientAge').textContent,
                    deviceId: document.getElementById('deviceId').textContent
                },
                sensorData: sensorData
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `pe-dvt-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            addAlert('info', 'Data exported successfully');
        }

        // Reset alerts
        function resetAlerts() {
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = `
                <div class="alert info">
                    <div class="alert-time">Alerts cleared</div>
                    <div>All alerts have been acknowledged and cleared.</div>
                </div>
            `;
        }
    </script>
</body>
</html>